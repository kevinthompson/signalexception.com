<!DOCTYPE html>
<html>
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <title>Reset Batman.js Object Attributes | Kevin Thompson</title>
    <meta content="Web Application Developer from Oceanside, CA" name="description">
    <meta content="Kevin Thompson, web development in san diego, web developer in san diego, san diego user experience, ruby developer, responsive design, php, ruby, javascript" name="keywords">
    <meta content="width=device-width; initial-scale=1.0; maximum-scale=1.0;" name="viewport">
    <link href="http://kevinthompson.info/feed.xml" rel="alternate" title="Kevin Thompson's Blog" type="application/rss+xml">
    <link href="https://plus.google.com/115586748098657149997" rel="author">
    <link href="/stylesheets/all-748bf9c3.css" media="screen" rel="stylesheet" type="text/css">
    <script>
      var html = document.getElementsByTagName('html')[0];
      html.className = (html.className != '' ? html.className + ' ' : '') + 'js';
      /mobile/i.test(navigator.userAgent) && !location.hash && setTimeout(function () { window.scrollTo(0, 1); }, 1000);
    </script>
    <!--[if lt IE 9]> <script src="//ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js">IE7_PNG_SUFFIX=".png";</script> <![endif]-->
  </head>
  <body>
    <div class="blog 2013 01 28 reset-batman-js-object-attributes.html" id="main">
      <header id="header">
          <a id="logo" href="/"><img alt="Kevin Thompson" src="/images/logo-cyan-89700747.png">
        <h1>Kevin Thompson</h1>
        </a>
      
        <div class="title">
          Developer
        </div>
        <nav>
              <a class="alt button back" href="/"><span>Home</span>
          </a>
      
          <a class="alt button" href="#menu">Menu</a>
        </nav>
      </header>
      <hr>
      <div id="content">
        <article class="post">
          <h1>Reset Batman.js Object Attributes</h1>
          <p class="author">
            by
            <a href="http://linkedin.com/in/kevindthompson">Kevin Thompson</a>
          </p>
          <p class="date">January 28, 2013</p>
          <p>Today I was trying to find a way to reset the attributes of an object in <a href="http://batmanjs.org">Batman.js</a> if, for example, the object was being edited in a model window and the user clicked a "cancel" button.</p>
          
          <p>Since Batman.js already stores the modified keys and their original values in a hash accessible through the <code>dirtyKeys</code> method, I simply needed to iterate over that hash, setting each key equal to its original value:</p>
          
          <pre><code class="highlighted"><span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Model</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Model</span>
    <span class="c1"># ...</span>
    <span class="nv">reset: </span><span class="o">-&gt;</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s">'dirtyKeys'</span><span class="p">).</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="nx">val</span><span class="p">)</span>
</code></pre>
          
          <p>This method works great for resetting a single object, but I quickly realized that I often edit related objects within the same modal as their parent (an example being multiple email address objects belonging to a person object). To expand the reset functionality, I started looking into how I might crawl the tree of relationships for a given model.</p>
          
          <p>After a bit of tinkering, <a href="https://twitter.com/theberg">Jeff Berg</a> and I eventually came up with the following solution:</p>
          
          <pre><code class="highlighted"><span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Model</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Model</span>
    <span class="c1"># ...</span>
    <span class="nv">reset: </span><span class="o">-&gt;</span>
      <span class="nx">@get</span><span class="p">(</span><span class="s">'dirtyKeys'</span><span class="p">).</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="nx">val</span><span class="p">)</span>
      <span class="nv">associations = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">_batman</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">'associations'</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">associations</span><span class="o">?</span>
      <span class="nv">hasAssociations = </span><span class="k">new</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">SimpleSet</span>
      <span class="nv">hasAssociations = </span><span class="nx">hasAssociations</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">associations</span><span class="p">.</span><span class="nx">getByType</span><span class="p">(</span><span class="s">'hasMany'</span><span class="p">))</span> <span class="k">if</span> <span class="nx">associations</span><span class="p">.</span><span class="nx">getByType</span><span class="p">(</span><span class="s">'hasMany'</span><span class="p">)</span><span class="o">?</span>
      <span class="nv">hasAssociations = </span><span class="nx">hasAssociations</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">associations</span><span class="p">.</span><span class="nx">getByType</span><span class="p">(</span><span class="s">'hasOne'</span><span class="p">))</span> <span class="k">if</span> <span class="nx">associations</span><span class="p">.</span><span class="nx">getByType</span><span class="p">(</span><span class="s">'hasOne'</span><span class="p">)</span><span class="o">?</span>
      <span class="nx">hasAssociations</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">association</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">className = </span><span class="nx">association</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span>
        <span class="nv">relatedModel = </span><span class="nx">Batman</span><span class="p">.</span><span class="nx">currentApp</span><span class="o">?</span><span class="p">[</span><span class="nx">className</span><span class="p">]</span>
        <span class="nv">objects = </span><span class="nx">relatedModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">'loaded'</span><span class="p">).</span><span class="nx">indexedBy</span><span class="p">(</span><span class="nx">association</span><span class="p">.</span><span class="nx">foreignKey</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">@get</span><span class="p">(</span><span class="s">'id'</span><span class="p">))</span>
        <span class="nx">objects</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
</code></pre>
          
          <p>The additional block of code here starts by grabbing all associations on the object that create either a <code>hasMany</code> or a <code>hasOne</code> relationship. For each relevant association found, we then get all loaded objects for that association's model (as to avoid loading objects that have not yet been retrieved or modified) and reset those child objects as well.</p>
          
          <p>Once our reset method is in place, we simply need to call the method on a loaded object:</p>
          
          <pre><code class="highlighted"><span class="nv">person = </span><span class="nx">App</span><span class="p">.</span><span class="nx">Person</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">'name'</span><span class="p">)</span>              <span class="c1">#=&gt; 'Sterling Archer'</span>
  <span class="nx">person</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="s">'Dutchess'</span><span class="p">)</span>  <span class="c1">#=&gt; 'Dutchess'</span>
  <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">'name'</span><span class="p">)</span>              <span class="c1">#=&gt; 'Dutchess'</span>
  <span class="nx">person</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
  <span class="nx">person</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">'name'</span><span class="p">)</span>              <span class="c1">#=&gt; 'Sterling Archer'</span>
</code></pre>
          
        </article>
      </div>
      <hr>
      <nav class="menu" id="menu">
        <ul>
          <li><a href="/">Blog</a></li>
          <!-- %li= link_to 'About', '/about/' -->
        </ul>
        <ul class="external">
          <li>
                  <a class="alt button" href="http://github.com/kevinthompson"><span>Fork My Code on</span>
            Github
            </a>
      
          </li>
          <li>
                  <a class="alt button" href="http://linkedin.com/in/kevindthompson"><span>View My Resume on</span>
            LinkedIn
            </a>
      
          </li>
          <li>
                  <a class="alt button" href="http://twitter.com/kevinthompson"><span>Follow Me on</span>
            Twitter
            </a>
      
          </li>
          <li>
                  <a class="alt button" href="https://plus.google.com/115586748098657149997?rel=author">Google
            </a>
      
          </li>
        </ul>
        <ul class="external">
          <li>
                  <a class="alt button" href="http://kevinthompson.info/feed.xml">Subscribe
            <span>to my Blog</span>
            </a>
      
          </li>
        </ul>
      </nav>
      <hr>
      <footer>
        <div class="copyright">
          © Kevin Thompson 2013
          <span>— Code, Content &amp; Design</span>
        </div>
        <a href="#header">Top ↑</a>
      </footer>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
      <script src="/javascripts/all-9b489943.js" type="text/javascript"></script>
    </div>
  <script type="text/javascript">
if (typeof gaJsHost == 'undefined') {
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
}
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-24584832-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
