<!DOCTYPE html>
<html>
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <title>Supporting Rails Nested Attributes in Batman.js | Kevin Thompson</title>
    <meta content="Web Application Developer from Oceanside, CA" name="description">
    <meta content="Kevin Thompson, web development in san diego, web developer in san diego, san diego user experience, ruby developer, responsive design, php, ruby, javascript" name="keywords">
    <meta content="width=device-width; initial-scale=1.0; maximum-scale=1.0;" name="viewport">
    <link href="http://kevinthompson.info/feed.xml" rel="alternate" title="Kevin Thompson's Blog" type="application/rss+xml">
    <link href="https://plus.google.com/115586748098657149997" rel="author">
    <link href="/stylesheets/all-748bf9c3.css" media="screen" rel="stylesheet" type="text/css">
    <script>
      var html = document.getElementsByTagName('html')[0];
      html.className = (html.className != '' ? html.className + ' ' : '') + 'js';
      /mobile/i.test(navigator.userAgent) && !location.hash && setTimeout(function () { window.scrollTo(0, 1); }, 1000);
    </script>
    <!--[if lt IE 9]> <script src="//ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js">IE7_PNG_SUFFIX=".png";</script> <![endif]-->
  </head>
  <body>
    <div class="blog 2012 12 supporting-rails-nested-attributes-in-batman-js.html" id="main">
      <header id="header">
          <a id="logo" href="/"><img alt="Kevin Thompson" src="/images/logo-cyan-89700747.png">
        <h1>Kevin Thompson</h1>
        </a>
      
        <div class="title">
          Developer
        </div>
        <nav>
              <a class="alt button back" href="/"><span>Home</span>
          </a>
      
          <a class="alt button" href="#menu">Menu</a>
        </nav>
      </header>
      <hr>
      <div id="content">
        <article class="post">
          <h1>Supporting Rails Nested Attributes in Batman.js</h1>
          <p class="author">
            by
            <a href="http://linkedin.com/in/kevindthompson">Kevin Thompson</a>
          </p>
          <p class="date">December 12, 2012</p>
          <p>I've recently begun working with <a href="http://batmanjs.org">Batman.js</a>, and while it goes a long way to be very Rails-like, there are a few instances which aren't yet accounted for. Once such instance is returning nested resources.</p>
          
          <p>In Rails, when you'd like to persist the attributes for a nested resource through a form generated for its parent object, you simply need to use the <code>accepts_nested_attributes_for</code> class method to prepare the child relationship, then use a <code>fields_for</code> block in your form for your nested resource object(s) that will automatically append <code>_attributes</code> to the field names.</p>
          
          <p>It's slightly more difficult to do the same in Batman.js because Batman  preserves the structure of the JSON originally returned from your application. This means that if your application returns an object such as the following for a store entry, and your application's store model accepts nested attributes for products, when the products are posted back it would expected the <code>products</code> key to be <code>products_attributes</code>.</p>
          
          <pre><code class="highlighted"><span class="p">{</span>
    <span class="nx">id</span><span class="o">:</span> <span class="mi">14352</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">'ISIS Merch'</span>
    <span class="nx">Products</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Sterling Malory Archer Autographed Photo'</span>
        <span class="nx">price</span><span class="o">:</span> <span class="mf">199.99</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
</code></pre>
          
          <p>Because Batman.js has no way of knowing what nested resources a model accepts nested attributes for, we need to add that functionality ourselves. This particular solution involves extending two core Batman.js classes, then adding a single method call to our Batman models which accept nested attributes.</p>
          
          <h2>Solution</h2>
          
          <p>We first need to extend <code>Batman.Model</code> in order to create an array to store the keys for which nested resource attributes are accepted. In this file we also define a persistence class which I provide more detail about below.</p>
          
          <pre><code class="highlighted"><span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Model</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">Model</span>
  
    <span class="nx">@persist</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Storage</span>
  
    <span class="vi">@encodeAttributesFor: </span><span class="o">-&gt;</span>
      <span class="nx">@encodeAttributesForKeys</span> <span class="o">?=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">arguments</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">==</span> <span class="s">'string'</span>
          <span class="nx">@encodeAttributesForKeys</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nv">index = </span><span class="nx">@encodeAttributesForKeys</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nx">@encodeAttributesForKeys</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span>
</code></pre>
          
          <p>Once we have a way to store the nested resource keys, we need a way to act on them. For this we'll tap into Batman's storage class callbacks. More specifically, we will add a before create and update call back that appends <code>_attributes</code> to each of the previously defined keys in our JSON output.</p>
          
          <pre><code class="highlighted"><span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Storage</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RailsStorage</span>
  
    <span class="nx">@</span><span class="o">::</span><span class="nx">before</span> <span class="s">'create'</span><span class="p">,</span> <span class="s">'update'</span><span class="p">,</span> <span class="nf">(env, next) -&gt;</span>
      <span class="nv">data = </span><span class="nx">env</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">data</span>
      <span class="k">if</span> <span class="nv">namespace = </span><span class="nx">@recordJsonNamespace</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">subject</span><span class="p">)</span>
        <span class="nv">obj = </span><span class="nx">data</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nv">obj = </span><span class="nx">data</span>
  
      <span class="k">if</span> <span class="nx">env</span><span class="p">.</span><span class="nx">subject</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">encodeAttributesForKeys</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">env</span><span class="p">.</span><span class="nx">subject</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">encodeAttributesForKeys</span>
          <span class="k">if</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
            <span class="nx">obj</span><span class="p">[</span><span class="s">"</span><span class="si">#{</span><span class="nx">key</span><span class="si">}</span><span class="s">_attributes"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span>
            <span class="k">delete</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nx">next</span><span class="p">()</span>
</code></pre>
          
          <p>With the key array and storage mechanisms in place, the final step is to simply define which fields the <code>_attributes</code> suffix should be applied to.</p>
          
          <pre><code class="highlighted"><span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Store</span> <span class="k">extends</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Model</span>
  
    <span class="nx">@hasMany</span> <span class="s">'products'</span>
    <span class="nx">@encodeAttributesFor</span> <span class="s">'products'</span>
</code></pre>
          
          <hr>
          
          <h2>Update – January 29, 2013</h2>
          
          <p>After spending a bit more time working with this technique, I realized that there were a few actions that also needed to be taken on these nested objects after a successful updated:</p>
          
          <ol>
          <li>If objects are flagged for deletion using the <code>_destroy</code> flag, they should be removed after update.</li>
          <li>A nested object's <code>dirtyKeys</code> should be cleared after update so that the updated values are now the "original" values.</li>
          </ol>
          
          <p>Both of these updates have been added in a single <code>@::after</code> callback on the storage class exemplified below.</p>
          
          <pre><code class="highlighted"><span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Storage</span> <span class="k">extends</span> <span class="nx">Batman</span><span class="p">.</span><span class="nx">RailsStorage</span>
  
    <span class="c1"># ...</span>
  
    <span class="nx">@</span><span class="o">::</span><span class="nx">after</span> <span class="s">'update'</span><span class="p">,</span> <span class="nx">@skipIfError</span> <span class="nf">(env, next) -&gt;</span>
      <span class="k">if</span> <span class="nx">env</span><span class="p">.</span><span class="nx">subject</span> <span class="o">and</span> <span class="nx">env</span><span class="p">.</span><span class="nx">subject</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">encodeAttributesForKeys</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">env</span><span class="p">.</span><span class="nx">subject</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">encodeAttributesForKeys</span>
          <span class="nv">objects = </span><span class="nx">env</span><span class="p">.</span><span class="nx">subject</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">objects</span><span class="o">?</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s">'AssociationSet'</span>
            <span class="nx">objects</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(object) -&gt;</span>
              <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">'_destroy'</span><span class="p">)</span>
                <span class="nx">objects</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> 
              <span class="k">else</span>
                <span class="nx">object</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">'dirtyKeys'</span><span class="p">).</span><span class="nx">clear</span><span class="p">()</span>
                <span class="nx">object</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">'_dirtiedKeys'</span><span class="p">).</span><span class="nx">clear</span><span class="p">()</span>
</code></pre>
          
          <hr>
          
          <p>A complete gist of this example is available on Github here: <a href="https://gist.github.com/4219217">https://gist.github.com/4219217</a></p>
          
        </article>
      </div>
      <hr>
      <nav class="menu" id="menu">
        <ul>
          <li><a href="/">Blog</a></li>
          <!-- %li= link_to 'About', '/about/' -->
        </ul>
        <ul class="external">
          <li>
                  <a class="alt button" href="http://github.com/kevinthompson"><span>Fork My Code on</span>
            Github
            </a>
      
          </li>
          <li>
                  <a class="alt button" href="http://linkedin.com/in/kevindthompson"><span>View My Resume on</span>
            LinkedIn
            </a>
      
          </li>
          <li>
                  <a class="alt button" href="http://twitter.com/kevinthompson"><span>Follow Me on</span>
            Twitter
            </a>
      
          </li>
          <li>
                  <a class="alt button" href="https://plus.google.com/115586748098657149997?rel=author">Google
            </a>
      
          </li>
        </ul>
        <ul class="external">
          <li>
                  <a class="alt button" href="http://kevinthompson.info/feed.xml">Subscribe
            <span>to my Blog</span>
            </a>
      
          </li>
        </ul>
      </nav>
      <hr>
      <footer>
        <div class="copyright">
          © Kevin Thompson 2013
          <span>— Code, Content &amp; Design</span>
        </div>
        <a href="#header">Top ↑</a>
      </footer>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
      <script src="/javascripts/all-9b489943.js" type="text/javascript"></script>
    </div>
  <script type="text/javascript">
if (typeof gaJsHost == 'undefined') {
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
}
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-24584832-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
