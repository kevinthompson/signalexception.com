// jquery.pjax.js
// copyright chris wanstrath
// https://github.com/defunkt/jquery-pjax
(function(e){function t(t,r,i){var s=this;return this.on("click.pjax",t,function(t){var o=e.extend({},h(r,i));o.container||(o.container=e(this).attr("data-pjax")||s),n(t,o)})}function n(t,n,r){r=h(n,r);var s=t.currentTarget;if(s.tagName.toUpperCase()!=="A")throw"$.fn.pjax or $.pjax.click requires an anchor element";if(t.which>1||t.metaKey||t.ctrlKey||t.shiftKey||t.altKey)return;if(location.protocol!==s.protocol||location.host!==s.host)return;if(s.hash&&s.href.replace(s.hash,"")===location.href.replace(location.hash,""))return;if(s.href===location.href+"#")return;var o={url:s.href,container:e(s).attr("data-pjax"),target:s,fragment:null};i(e.extend({},o,r)),t.preventDefault()}function r(t,n,r){r=h(n,r);var s=t.currentTarget;if(s.tagName.toUpperCase()!=="FORM")throw"$.pjax.submit requires a form element";var o={type:s.method,url:s.action,data:e(s).serializeArray(),container:e(s).attr("data-pjax"),target:s,fragment:null,timeout:0};i(e.extend({},o,r)),t.preventDefault()}function i(t){function u(t,r){var i=e.Event(t,{relatedTarget:n});return s.trigger(i,r),!i.isDefaultPrevented()}t=e.extend(!0,{},e.ajaxSettings,i.defaults,t),e.isFunction(t.url)&&(t.url=t.url());var n=t.target,r=c(t.url).hash,s=t.context=p(t.container);t.data||(t.data={}),t.data._pjax=s.selector;var a;t.beforeSend=function(e,n){n.type!=="GET"&&(n.timeout=0),n.timeout>0&&(a=setTimeout(function(){u("pjax:timeout",[e,t])&&e.abort("timeout")},n.timeout),n.timeout=0),e.setRequestHeader("X-PJAX","true"),e.setRequestHeader("X-PJAX-Container",s.selector);var r;if(!u("pjax:beforeSend",[e,n]))return!1;t.requestUrl=c(n.url).href},t.complete=function(e,n){a&&clearTimeout(a),u("pjax:complete",[e,n,t]),u("pjax:end",[e,t])},t.error=function(e,n,r){var i=v("",e,t),s=u("pjax:error",[e,n,r,t]);t.type=="GET"&&n!=="abort"&&s&&o(i.url)},t.success=function(n,a,l){var h=v(n,l,t);if(!h.contents){o(h.url);return}i.state={id:t.id||f(),url:h.url,title:h.title,container:s.selector,fragment:t.fragment,timeout:t.timeout},(t.push||t.replace)&&window.history.replaceState(i.state,h.title,h.url),h.title&&(document.title=h.title),s.html(h.contents),typeof t.scrollTo=="number"&&e(window).scrollTop(t.scrollTo),(t.replace||t.push)&&window._gaq&&_gaq.push(["_trackPageview"]);if(r!==""){var p=c(h.url);p.hash=r,i.state.url=p.href,window.history.replaceState(i.state,h.title,p.href);var d=e(p.hash);d.length&&e(window).scrollTop(d.offset().top)}u("pjax:success",[n,a,l,t])},i.state||(i.state={id:f(),url:window.location.href,title:document.title,container:s.selector,fragment:t.fragment,timeout:t.timeout},window.history.replaceState(i.state,document.title));var h=i.xhr;h&&h.readyState<4&&(h.onreadystatechange=e.noop,h.abort()),i.options=t;var h=i.xhr=e.ajax(t);return h.readyState>0&&(t.push&&!t.replace&&(b(i.state.id,s.clone().contents()),window.history.pushState(null,"",l(t.requestUrl))),u("pjax:start",[h,t]),u("pjax:send",[h,t])),i.xhr}function s(t,n){var r={url:window.location.href,push:!1,replace:!0,scrollTo:!1};return i(e.extend(r,h(t,n)))}function o(e){window.history.replaceState(null,"","#"),window.location.replace(e)}function u(t){var n=t.state;if(n&&n.container){var r=e(n.container);if(r.length){var s=m[n.id];if(!i.state){i.state=n;return}var u=i.state.id<n.id?"forward":"back";w(u,i.state.id,r.clone().contents());var a=e.Event("pjax:popstate",{state:n,direction:u});r.trigger(a);var f={id:n.id,url:n.url,container:r,push:!1,fragment:n.fragment,timeout:n.timeout,scrollTo:!1};s?(r.trigger("pjax:start",[null,f]),n.title&&(document.title=n.title),r.html(s),i.state=n,r.trigger("pjax:end",[null,f])):i(f),r[0].offsetHeight}else o(location.href)}}function a(t){var n=e.isFunction(t.url)?t.url():t.url,r=t.type?t.type.toUpperCase():"GET",i=e("<form>",{method:r==="GET"?"GET":"POST",action:n,style:"display:none"});r!=="GET"&&r!=="POST"&&i.append(e("<input>",{type:"hidden",name:"_method",value:r.toLowerCase()}));var s=t.data;if(typeof s=="string")e.each(s.split("&"),function(t,n){var r=n.split("=");i.append(e("<input>",{type:"hidden",name:r[0],value:r[1]}))});else if(typeof s=="object")for(key in s)i.append(e("<input>",{type:"hidden",name:key,value:s[key]}));e(document.body).append(i),i.submit()}function f(){return(new Date).getTime()}function l(e){return e.replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"")}function c(e){var t=document.createElement("a");return t.href=e,t}function h(t,n){return t&&n?n.container=t:e.isPlainObject(t)?n=t:n={container:t},n.container&&(n.container=p(n.container)),n}function p(t){t=e(t);if(!t.length)throw"no pjax container for "+t.selector;if(t.selector!==""&&t.context===document)return t;if(t.attr("id"))return e("#"+t.attr("id"));throw"cant get selector for pjax container!"}function d(e,t){return e.filter(t).add(e.find(t))}function v(t,n,r){var i={};i.url=l(n.getResponseHeader("X-PJAX-URL")||r.requestUrl);if(/<html/i.test(t))var s=e(t.match(/<head[^>]*>([\s\S.]*)<\/head>/i)[0]),o=e(t.match(/<body[^>]*>([\s\S.]*)<\/body>/i)[0]);else var s=o=e(t);if(o.length===0)return i;i.title=d(s,"title").last().text();if(r.fragment){if(r.fragment==="body")var u=o;else var u=d(o,r.fragment).first();u.length&&(i.contents=u.contents(),i.title||(i.title=u.attr("title")||u.data("title")))}else/<html/i.test(t)||(i.contents=o);return i.contents&&(i.contents=i.contents.not("title"),i.contents.find("title").remove()),i.title&&(i.title=e.trim(i.title)),i}function b(e,t){m[e]=t,y.push(e);while(g.length)delete m[g.shift()];while(y.length>i.defaults.maxCacheLength)delete m[y.shift()]}function w(e,t,n){var r,i;m[t]=n,e==="forward"?(r=y,i=g):(r=g,i=y),r.push(t),(t=i.pop())&&delete m[t]}function E(){e.fn.pjax=t,e.pjax=i,e.pjax.enable=e.noop,e.pjax.disable=S,e.pjax.click=n,e.pjax.submit=r,e.pjax.reload=s,e.pjax.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html",scrollTo:0,maxCacheLength:20},e(window).bind("popstate.pjax",u)}function S(){e.fn.pjax=function(){return this},e.pjax=a,e.pjax.enable=E,e.pjax.disable=e.noop,e.pjax.click=e.noop,e.pjax.submit=e.noop,e.pjax.reload=function(){window.location.reload()},e(window).unbind("popstate.pjax",u)}var m={},g=[],y=[];e.inArray("state",e.event.props)<0&&e.event.props.push("state"),e.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),e.support.pjax?E():S()})(jQuery),function(){$(document).on("click","a",function(e){var t,n;t=$(e.currentTarget);if(t.is('a[href^="/"]')){e.preventDefault(),n=t.attr("href");if(n!==window.location.pathname)return $.pjax({url:n,container:"#content",fragment:"#content",timeout:5e3})}else if(t.is($("a").not('[href^="#"],[href^="/"],[href*="#{document.domain}"]')))return t.attr("target","_blank")})}.call(this);